div(id='player', class='flex-centered')
div(class='not-flex-centered')

  // row for "load video"
  div(class='row')
    div(class='col-md-1')
    form(class='form-group', id='load_video', action='')
      div(class='col-md-5')
        input(class='form-control', id='video_id',
              style='margin:0 0 10px 0;',
              placeholder='Search / video ID / URL')
      div(class='col-md-2')
        button(class='btn btn-default') Enqueue
      div(class='col-md-2')
        button(class='btn btn-default', id='dequeue') Dequeue
      div(class='col-md-1')
        button(class='btn btn-default', id='skip') Skip
      div(class='col-md-1')
        button(class='btn btn-default', id='mute')
          span(id='mute-icon', class='glyphicon glyphicon-volume-up',
               aria-hidden='true')

  // row for "load playlist"
  //div(class='row')
    div(class='col-md-2')
    form(class='form-group', id='load_playlist', action='')
      div(class='col-md-5')
        input(class='form-control', id='playlist_id',
              style='margin:0 0 10px 0;',
              placeholder='Load playlist by ID')
      div(class='col-md-2')
        button(class='btn btn-default') Load

  // Devote the rest to the queue
  ul(id="video-queue", class="jub-list")

script.

  var my_video_state = {};
  var MAX_RESULTS = 7;
  var MAX_PRETTY_LEN = 60;

  // e.g. "michelleheafy: Some cool video about someth..."
  function prettify_result(result) {
    var artist = result.snippet.channelTitle
    var pretty = artist + ": " + result.snippet.title;
    if (pretty.length > MAX_PRETTY_LEN) {
      pretty = pretty.slice(0, MAX_PRETTY_LEN - 3) + "...";
    }
    return pretty
  }

  // Take in youtube search result items and turn them into an array of objects
  // that autocomplete can handle, truncating the list in the process
  function transform_search_results(results) {
    return results.slice(0, MAX_RESULTS).map(function(result) {
      return {
        label: prettify_result(result),
        value: result.id.videoId
      }
    });
  }

  $('#video_id').autocomplete({
    // Request a video search; once the results come back, update the UI
    source: function(request, response) {
      socket.emit('video search', request['term'], function(results) {
        response(transform_search_results(results));
      })
    },

    // Populate the search box with the video's title, not ID
    focus: function(event, ui) {
      $('#video_id').val(ui.item.label);
      return false;
    },

    // When a user chooses a suggestion (hits enter) start the video
    select: function(event, ui) {
      var event = jQuery.Event("submit");
      event.video_id = ui.item.value;
      $('#load_video').trigger(event);
      return false;
    },
    minLength: 5
  });

  // Client text box for submitting a video
  $('#load_video').submit(function(event) {
    // We might have been invoked straight from an autocomplete callback,
    // in which case the value of the search box is not the video id; it's
    // a pretty label, and the video id was passed in with the event.
    var video_id = event.video_id;

    // We were invoked via a normal form submit
    if (video_id == undefined) {
      video_id = $('#video_id').val();
    }

    // Accept URLs
    if (video_id.starts_with('https:\/\/www.youtube.com')) {
      video_id = video_id.split('watch?v=')[1];
    }

    // TODO verify that it's a valid ID before submitting

    // send the new video state out and clear the video search box
    var new_video = {
      user: get_cookie('username'),
      id: video_id
    }
    console.log('submitting', new_video);
    socket.emit('video submit', new_video); // TODO call it enqueue
    $('#video_id').val('');
    return false;
  });

  $('#load_playlist').submit(function(event) {
    var playlist_id = $('#playlist_id').val();
    console.log('playlist submission:', playlist_id);
    var playlist_obj = {
      user: get_cookie('username'),
      playlist_id: playlist_id
    }
    socket.emit('playlist submit', playlist_obj);
    return false;
  });

  // Start the specified video, starting at the correct time
  function apply_video_state(state) {
    id =  state['id'];
    start_time = state['start_time'];
    user = state['user'];
    if (my_video_state['id'] != id ||
        my_video_state['start_time'] != start_time) {
      my_video_state = {
        user: user,
        id: id,
        start_time: start_time
      };
      video_progress = (state['server_time'] - start_time) / 1000;
      console.log("apply video state", id, video_progress);
      player.loadVideoById({
        'videoId': id,
        'startSeconds': video_progress,
        'suggestedQuality': 'large'
      });
    }
  }

  // Server tells us about video state changes
  socket.on('video state', function(video_state) {
    apply_video_state(video_state);
  });

  // Server tells us about video state changes
  socket.on('video queue', function(queue) {
    console.log('video queue', queue);
    $('#video-queue').empty();
    for (video of queue) {
      var item = $('<li>').text(video['user'] + ': ' + video['title']);
      $('#video-queue').prepend(item);
    }
  });

  // Dequeue
  $('#dequeue').on('click', function(e) {
    var user = get_cookie('username');
    console.log('sending dequeue for:', user);
    socket.emit('video dequeue', user);
    return false;
  });

  // Skip
  $('#skip').on('click', function(e) {
    var user = get_cookie('username');
    console.log('sending skip from:', user);
    socket.emit('video skip', user);
    return false;
  });

  // Mute button
  $('#mute').on('click', function(e) {
    e.preventDefault();
    if (player.isMuted()) {
      player.unMute();
      $('#mute-icon').attr('class', 'glyphicon glyphicon-volume-up');
    }
    else {
      player.mute();
      $('#mute-icon').attr('class', 'glyphicon glyphicon-volume-off');
    }
    return false;
  });

  /* Everything below here is boilerplate for the Google YT IFrame */

  // Load the IFrame Player API code, asynchronously
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Create an <iframe> (and YouTube player) after the API code downloads.
  var player;
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '320',
      width: '525',
      playerVars: {
        'autoplay': 0,
        'autohide': 1,
        'controls': 0,
        'rel': 0,
        'disablekb': 1,
        'modestbranding': 1,
        // TODO add 'origin' param; set it to my domain
        'iv_load_policy': 0
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }

  // The API will call this function when the video player is ready.
  function onPlayerReady(event) {
    player.unMute();
    socket.emit('video state', 0);
  }

  // The API calls this function when the player's state changes.
  // The function indicates that when playing a video (state=1),
  // the player should play for six seconds and then stop.
  var done = false;
  function onPlayerStateChange(event) {
    console.log("player state change:", event.data)
    if (event.data == YT.PlayerState.PAUSED) {
      event.target.playVideo(); // TODO does this violate the youtube ToS?
    }
  }


