#!/bin/bash -e

if [ ! -f $1 ]; then
  echo "No such file"
  exit 1
fi

top_dir=$(cd $(dirname $0)/../.. && pwd)
bin="$top_dir/bin"
test="$top_dir/test"
test_bin="$test/bin"
test_artifacts="$test/artifacts"
nightwatch="$top_dir/node_modules/nightwatch/bin/nightwatch"

cd $top_dir

echo "=== Running UI test case" $(basename $1)
echo

[ -f $test/chat_cache ] && rm $test/chat_cache
[ -d $test_artifacts ] && rm -r $test_artifacts
mkdir -p $test_artifacts

export TEST=1
export PORT=3001
export JUB_CONFIG=$test/config.js

node $test/bin/drop_db.js
echo "Starting jub pub server"
(node bin/www >> $test_artifacts/server.out 2>&1)&
server_pid=$!
sleep 5

$nightwatch -c $test/nightwatch.json -t $1

kill $server_pid
